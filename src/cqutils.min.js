function saturate(t,i,s){var e=i>t?i:t;return e>s?s:e}function wrap(t,i,s){return t>s?i+(t-i)%(s+1-i):i>t?i+(t+(s-i)-1)%(s+1-i):t}function sequence(t,i,s){var e=[];s||(s=1);for(var r=t;i>=r;r+=s)e.push(r);return e}function rand(t){return Math.floor(Math.random()*t)}function randc(t){return Math.floor(Math.random()*t)*(Math.random()<.5?-1:1)}function frand(t){return Math.random()*t}function frandc(t){return Math.random()*t*(Math.random()<.5?-1:1)}function dist(t,i,s,e){var r=t-s,h=i-e;return Math.sqrt(r*r+h*h)}function dist2(t,i,s,e){var r=t-s,h=i-e;return r*r+h*h}function intersection(t,i,s,e,r,h,a,n){if(6==arguments.length)a=1,n=1;else if(3==arguments.length){var o=t;r=i,h=s,a=1,n=1,t=o[0],i=o[1],s=o[2],e=o[3]}else if(2==arguments.length){var o=t,f=i;t=o[0],i=o[1],s=o[2],e=o[3],r=f[0],h=f[1],a=void 0===f[2]?1:f[2],n=void 0===f[3]?1:f[3]}return r+a>=t&&t+s>=r&&h+n>=i&&i+e>=h}function setCursor(t){app.layer.canvas.style.cursor=t}function atlasFromSpritesheet(t,i,s,e){for(var r={image:t,frames:[]},h=F(t.width/s),a=0;i>a;a++)r.frames.push({region:[a%h*s,F(a/h)*e,s,e],offset:[0,0],width:s,height:e});return r}function parseBitmapFont(t,i,s,e){var r,h,a,n,o,f={};f.image=t,f.spacewidth=F(.5*s),f.letterspacing=1,f.lineheight=F(1.2*t.height);var l=cq(t.width,t.height).drawImage(t,0,0);for(var c in i){r=c*s,h=r+s,n=o=!1;for(var u=0;s>u;u++){for(var m=l.height-1;m>=0&&(n||(a=l.getPixel(r,m),a.equalsTo(e)||(n=!0)),o||(a=l.getPixel(h,m),a.equalsTo(e)||(o=!0)),!n||!o);m--);if(n&&o)break;n||r++,o||h--}n&&o&&(f[i[c]]={x:r,y:0,width:h-r+1,height:l.height})}return f}function debug(){for(var t=[],i=0;i<arguments.length;i++){var s=arguments[i];switch(typeOf(s)){case"array":t.push("["+s.join(", ")+"]");break;case"object":var e=[];for(var r in s)e.push(r+" "+s[r]);t.push("{"+e.join(", ")+"}");break;default:t.push(s)}}t=t.join(" "),app.layer.font("10px arial").fillStyle("#fff").wrappedText(t,2,10,app.width)}Timer=function(){this.time=0,this.table={},this.paused=!1,this.dt=0},Timer.prototype={step:function(t){this.paused||(this.time+=t,this.dt=t)},reset:function(){this.table={},this.time=0,thid.dt=0},pause:function(t){this.paused=void 0===t?!0:t},resume:function(){this.paused=!1},on:function(){var t=arguments;1==t.length&&"array"==typeOf(t[0])&&(t=t[0]);for(var i=0;i<t.length;i++)if(this.time>=t[i]&&void 0===this.table[t[i]])return this.table[t[i]]=!0,1;return 0},fromDuring:function(t,i){return saturate((this.time-t)/i,0,1)},fromTo:function(t,i){return saturate((this.time-t)/(i-t),0,1)}},M=Math,F=Math.floor;var typeOf=function(t){return{}.toString.call(t).match(/\s([a-zA-Z]+)/)[1].toLowerCase()};Sprite=function(t,i,s){switch(this.isAtlas=!1,this.img=null,typeOf(t)){case"array":this.img=t;break;case"htmlimageelement":this.img=[t];break;case"object":this.img=t,this.isAtlas=!0}this.x=i||0,this.y=s||0,this.fliph=!1,this.flipv=!1,this.rotation=0,this.anchor={x:0,y:0},this.animspeed=1,this.w=this.isAtlas?this.img.frames[0].width:this.img[0].width,this.h=this.isAtlas?this.img.frames[0].height:this.img[0].height,this._width=this.w,this._height=this.h,this.w2=F(this.w/2),this.h2=F(this.h/2),this._scalex=1,this._scaley=1,this.anims={},this.anim="",this.currentframe=0,this.frame=0,this.t,this.debug=!1},Sprite.prototype={tars:function(t,i,s,e,r,h){this.x=t,this.y=i,this.anchor.x=s,this.anchor.y=e,this.rotation=r,this._scalex=h,this._scaley=h},getBoundingBox:function(){return[this.x-this.anchor.x*this.w,this.y-this.anchor.y*this.h,this.w,this.h]},scale:function(t,i){this._scalex=t,this._scaley=i||t,this.w=this._width*this._scalex,this.h=this._height*this._scaley,this.w2=F(this.w/2),this.h2=F(this.h/2)},addAnimation:function(t,i,s,e){i||(i=sequence(0,this.isAtlas?this.img.frames.length-1:this.img.length-1)),this.anims[t]={frames:i,loop:s||!0,fps:e||30}},play:function(t,i){void 0!==this.anims[t]&&(this.anim=t,this.currentframe=void 0!==i?i:0,this.t=0)},step:function(t){this.t+=t*this.animspeed;var i=this.anims[this.anim];t>0&&this.t>=1/i.fps?(this.t=0,this.currentframe++,this.currentframe>=i.frames.length&&(this.currentframe=i.loop?0:i.frames.length)):0>t&&this.t<=-1/i.fps&&(this.t=0,this.currentframe--,this.currentframe<0&&(this.currentframe=i.loop?i.frames.length-1:0)),this.frame=i.frames[this.currentframe]},hitTest:function(t,i){var s=this.x-this.w*this.anchor.x,e=this.y-this.h*this.anchor.y;return 1==arguments.length?intersection(s,e,this.w,this.h,t.x,t.y,t.w,t.h):intersection(s,e,this.w,this.h,t,i)}},cq.Layer.prototype.drawSprite=function(t){if(this.stars(t.x,t.y,t.anchor.x,t.anchor.y,t.rotation,t._scalex*(t.fliph?-1:1),t._scaley*(t.flipv?-1:1)),t.isAtlas?this.drawAtlasFrame(t.img,t.frame,0,0):this.drawImage(t.img[t.frame],0,0),this.restore(),t.debug){var i=t.getBoundingBox();this.strokeStyle("#fff").strokeRect(i[0],i[1],i[2],i[3])}return this},ParticleSystem=function(t,i,s,e,r,h,a,n,o,f,l,c,u,m,p,d,g){this.x=t||0,this.y=i||0,this.size=s||0,this.num=e||10,this.vx=r||0,this.vy=h||0,this.vvar=a||1,this.drag=n||1,this.gravity=o||0,this.color=f||"#f00",this.colorvar=l||.5,this.parsize=c||2,this.parsizevar=u||0,this.life=m||5,this.lifevar=p||0,this.respawn=d||!0,this.delay=g||5,this.sprite=null,this.p=[],3==arguments.length&&"object"==typeof s&&this.preset(arguments[2]),this.init()},ParticleSystem.prototype={preset:function(t){for(var i in t)this[i]=t[i]},_initparticle:function(t){var i=this.p[t];i.x=this.x+frandc(this.size/2),i.y=this.y+frandc(this.size/2),i.vx=this.vx+frandc(this.vvar),i.vy=this.vy+frandc(this.vvar),i.color=cq.color(this.color).shiftHsl(M.random()*this.colorvar,M.random()*this.colorvar,M.random()*this.colorvar).toHex(),i.size=M.max(1,F(this.parsize+frandc(this.parsizevar))),i.life=this.life+frand(this.lifevar)+.1*M.random()},init:function(){for(var t=0;t<this.num;t++)this.p.push({id:t,x:0,y:0,vx:0,vy:0,color:0,size:0,life:0}),this._initparticle(t),this.p[t].life+=this.delay*M.random()},setSprite:function(t){this.sprite=t},respawnAllDeath:function(){for(var t=0;t<this.num;t++)this.p[t].life<0&&(this._initparticle(t),this.p[t].life+=this.delay*M.random())},respawnRandom:function(t){for(var i=0;t>i;i++){var s=rand(t);this._initparticle(s),this.p[s].life+=this.delay*M.random()}},step:function(t,i){for(var s,e=0;e<this.num;e++)s=this.p[e],s.life<0||(s.life-=t,s.life>this.life||(s.life<0?this.respawn&&this._initparticle(e):(s.x+=s.vx*t,s.y+=s.vy*t,s.vx*=this.drag,s.vy*=this.drag,void 0!==i&&i(t,s))))}},cq.Layer.prototype.drawParticleSystem=function(t){for(var i=0;i<t.num;i++){var s=t.p[i];s.life<0||s.life>t.life||(t.sprite?this.a(s.life/t.life).stars(s.x,s.y,.5,.5,0,s.size/t.size).drawImage(t.sprite,0,0).restore().ra():this.a(s.life/t.life).fillStyle(s.color).fillRect(s.x,s.y,F(s.size),F(s.size)).ra())}return this},SmokeParticleSystem={size:10,num:5,vx:0,vy:-40,vvar:20,drag:1.01,gravity:0,color:"#777",colorvar:.4,parsize:10,parsizevar:4,life:.5,lifevar:0,respawn:!1,delay:.1},cq.Color.prototype.equalsTo=function(t){return this[0]===t[0]&&this[1]===t[1]&&this[2]===t[2]&&this[3]===t[3]},cq.Layer.prototype.print=function(t,i,s,e,r){for(var h,a=s,n=e,o=void 0===r?i.length:F(i.length*saturate(r,0,1)),f=0;o>f;f++)h=i[f]," "!==h&&"	"!==h?"\n"!==h?(h=t[h],void 0!==h&&(this.drawRegion(t.image,[h.x,h.y,h.width,h.height],a,n),a+=h.width+t.letterspacing)):(a=s,n+=t.lineheight):a+=t.spacewidth;return this},cq.Layer.prototype.realNoise=function(t){},cq.Layer.prototype.noise=function(t){if(!(0>=t)){var i,s=this.context.getImageData(0,0,this.width,this.height),e=s.data,r=255*t,h=r/2;for(i=0;i<e.length;i+=4)e[i]=saturate(Math.floor(e[i]+M.random()*r-h),0,255),e[i+1]=saturate(Math.floor(e[i+1]+M.random()*r-h),0,255),e[i+2]=saturate(Math.floor(e[i+2]+M.random()*r-h),0,255);this.context.putImageData(s,0,0)}},cq.Layer.prototype.tint=function(t,i,s,e){if(!(0>=t)){var r=this.context.getImageData(0,0,this.width,this.height);i=i||0,s=s||0,e=e||0;var h,a=r.data,n=t,o=1-t;for(h=0;h<a.length;h+=4)a[h]=a[h]*o+i*n,a[h+1]=a[h+1]*o+s*n,a[h+2]=a[h+2]*o+e*n;this.context.putImageData(r,0,0)}},cq.Layer.prototype.scanlines=function(t){if(!(0>=t)){var i,s=this.width;for(this.a(t).strokeStyle("#000").lineWidth(1),i=.5;i<this.height;i+=2)this.strokeLine(0,i,s,i);this.ra()}};